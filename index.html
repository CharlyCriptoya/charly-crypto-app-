<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto • MVP</title>
<style>
  :root{ --bg:#0d0f12; --txt:#e9edf3; --mut:#9aa3b2; --card:#141824; --line:#232838; --chip:#1b2030; }
  *{ box-sizing:border-box }
  body{
    margin:0; color:var(--txt);
    background:#0d0f12 url("./Muro.jpeg") center/cover fixed no-repeat;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  }
  .veil{ background:linear-gradient(180deg, rgba(13,15,18,.65), rgba(13,15,18,.9)); min-height:100vh }
  .wrap{ max-width:1100px; margin:0 auto; padding:16px }
  h1{ margin:0 0 10px; font-size:22px; letter-spacing:.2px }
  .mut{ color:var(--mut) }
  .card{
    background: rgba(20,24,36,.86); border:1px solid var(--line);
    border-radius:12px; padding:12px; box-shadow: 0 6px 24px rgba(0,0,0,.28); margin-top:12px;
  }
  .section-title{ display:flex; justify-content:space-between; align-items:center }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0 }
  .chip{
    background:var(--chip); border:1px solid var(--line); border-radius:12px; padding:8px 12px;
    cursor:pointer; user-select:none; font-weight:700
  }
  .chip.active{ outline:2px solid #4060ff }
  table{ width:100%; border-collapse:collapse; margin-top:6px }
  th,td{ padding:10px 8px; border-bottom:1px solid var(--line); font-size:14px }
  th{ text-align:left; font-size:12px; color:var(--mut); text-transform:uppercase; letter-spacing:.4px }
  tr:hover td{ background:rgba(255,255,255,.02) }

  /* ===== Widget dólar ===== */
  .usdgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:10px}
  .usdcard{background:rgba(12,14,18,.72);border:1px solid var(--line);border-radius:14px;padding:14px}
  .usdtitle{font-size:12px;letter-spacing:.12em;color:var(--mut);text-transform:uppercase;margin-bottom:8px}
  .usdrow{display:flex;justify-content:space-between;align-items:baseline}
  .usdlabel{color:var(--mut);font-size:14px}
  .usdval{font-size:24px;font-weight:800}
  .usdact{color:var(--mut);font-size:12px;margin-top:6px}
</style>
</head>
<body>
<div class="veil">
  <div class="wrap">
    <h1>Charly Cripto • MVP <span class="mut">/ cotizaciones y señales rápidas</span></h1>

    <!-- ===== DÓLAR (ARRIBA) ===== -->
    <div class="card">
      <h2 style="margin:0 0 8px; font-size:24px; line-height:1.1">Cotizaciones del Dólar <span class="mut">(ARS)</span></h2>
      <div id="usdgrid" class="usdgrid"></div>
    </div>

    <!-- ===== BTC ===== -->
    <div class="card">
      <div class="section-title"><div><strong>Bitcoin</strong> <span class="mut">(BTC/ARS)</span></div></div>
      <table>
        <thead><tr><th>Exchange</th><th>Precio (ARS)</th><th>USD</th></tr></thead>
        <tbody id="tbl-btcars"><tr><td colspan="3" class="mut">Cargando…</td></tr></tbody>
      </table>
    </div>

    <!-- ===== ETH ===== -->
    <div class="card">
      <div class="section-title"><div><strong>Ethereum</strong> <span class="mut">(ETH/ARS)</span></div></div>
      <table>
        <thead><tr><th>Exchange</th><th>Precio (ARS)</th><th>USD</th></tr></thead>
        <tbody id="tbl-ethars"><tr><td colspan="3" class="mut">Cargando…</td></tr></tbody>
      </table>
    </div>

    <!-- ===== STABLECOINS (selector) ===== -->
    <div class="card">
      <div class="section-title"><div><strong>Stablecoins</strong> <span class="mut">(…/ARS)</span></div></div>
      <div id="chips-stables" class="chips"></div>
      <table>
        <thead><tr><th>Exchange</th><th>Precio (ARS)</th><th>USD</th></tr></thead>
        <tbody id="tbl-stable"><tr><td colspan="3" class="mut">Seleccionando…</td></tr></tbody>
      </table>
    </div>

    <!-- ===== SOLANA (selector) ===== -->
    <div class="card">
      <div class="section-title"><div><strong>Solana</strong> <span class="mut">(token / ARS)</span></div></div>
      <div id="chips-solana" class="chips"></div>
      <table>
        <thead><tr><th>Exchange</th><th>Precio (ARS)</th><th>USD</th></tr></thead>
        <tbody id="tbl-solana"><tr><td colspan="3" class="mut">Seleccionando…</td></tr></tbody>
      </table>
    </div>

    <div class="mut" style="margin:14px 2px 0; font-size:12px">Healthcheck: <code>/healthz</code>.</div>
  </div>
</div>

<script>
/* ===== Utils ===== */
const fmtARS = n => Number(n).toLocaleString('es-AR', { style:'currency', currency:'ARS', maximumFractionDigits:2 });
const fmtUSD = n => "US$ " + Number(n).toLocaleString('es-AR', { maximumFractionDigits:2 });

/* ===== DÓLAR ===== */
let usdData=null, usdTimer=null;
async function loadDolar(){
  try{
    const r = await fetch("/api/dolar");
    if(!r.ok) throw 0;
    usdData = await r.json();
    renderDollarCards();
  }catch(e){ console.log("dolar widget off", e); }
}
function renderDollarCards(){
  if(!usdData) return;
  const grid = document.getElementById("usdgrid");
  grid.innerHTML = "";
  const items = [
    ["Dólar Oficial", usdData.oficial],
    ["Dólar Tarjeta", usdData.tarjeta],
    ["Dólar Blue",    usdData.blue],
    ["Dólar MEP",     usdData.mep],
    ["Dólar CCL",     usdData.ccl],
    ["Dólar Cripto",  usdData.cripto],
  ];
  for(const [title, obj] of items){
    const venta = obj?.venta, compra = obj?.compra;
    const card = document.createElement("div");
    card.className = "usdcard";
    card.innerHTML = `
      <div class="usdtitle">${title}</div>
      <div class="usdrow"><div class="usdlabel">venta</div><div class="usdval">${venta!=null?fmtARS(venta):"—"}</div></div>
      <div class="usdrow" style="margin-top:4px"><div class="usdlabel">compra</div><div class="usdval">${compra!=null?fmtARS(compra):"—"}</div></div>
      <div class="usdact">act: <span class="actsec">0s</span></div>`;
    grid.appendChild(card);
  }
  if (usdTimer) clearInterval(usdTimer);
  usdTimer = setInterval(()=>{
    document.querySelectorAll(".usdact .actsec").forEach(el=>{
      const s = Math.floor((Date.now() - (usdData.ts||Date.now()))/1000);
      el.textContent = `${s}s`;
    });
  },1000);
}

/* ===== Proxy CriptoYa: trae TODOS los exchanges (incluye P2P) ===== */
async function fetchCripto(symbol, fiat="ars"){
  const r = await fetch(`/api/cripto/${symbol}/${fiat}`);
  if(!r.ok) throw 0;
  return r.json(); // objeto { exchange: { ars, usd, ...}, ... }
}
function renderTableFromCriptoYa(obj, tbodyId){
  const tbody = document.getElementById(tbodyId);
  const rows = Object.entries(obj || {}).map(([ex, v]) => ({
    ex,
    ars: v?.ars ?? null,
    usd: v?.usd ?? null
  }));
  // ordenar por ARS asc si hay
  rows.sort((a,b)=>{
    const A = a.ars ?? Infinity, B = b.ars ?? Infinity;
    return A - B;
  });
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${r.ex}</td>
      <td>${r.ars!=null ? fmtARS(r.ars) : "—"}</td>
      <td>${r.usd!=null ? fmtUSD(r.usd) : "—"}</td>
    </tr>
  `).join("") || `<tr><td colspan="3" class="mut">Sin datos</td></tr>`;
}

/* ===== Secciones fijas BTC/ETH ===== */
async function loadBTC(){ try{ renderTableFromCriptoYa(await fetchCripto("btc","ars"), "tbl-btcars"); }catch{} }
async function loadETH(){ try{ renderTableFromCriptoYa(await fetchCripto("eth","ars"), "tbl-ethars"); }catch{} }

/* ===== Stablecoins ===== */
const STABLES = [
  {k:"usdt",  label:"USDT"},
  {k:"usdc",  label:"USDC"},
  {k:"dai",   label:"DAI"},
  {k:"uxd",   label:"UXD"},
  {k:"usdp",  label:"USDP"},
  {k:"nuars", label:"NUARS"}
];
let currentStable = "usdt";
function setupStableChips(){
  const box = document.getElementById("chips-stables");
  box.innerHTML = "";
  STABLES.forEach(s=>{
    const c = document.createElement("div");
    c.className = "chip" + (s.k===currentStable ? " active": "");
    c.textContent = s.label;
    c.onclick = async ()=>{
      currentStable = s.k;
      document.querySelectorAll("#chips-stables .chip").forEach(x=>x.classList.remove("active"));
      c.classList.add("active");
      document.getElementById("tbl-stable").innerHTML = `<tr><td colspan="3" class="mut">Cargando ${s.label}…</td></tr>`;
      try{ renderTableFromCriptoYa(await fetchCripto(s.k,"ars"), "tbl-stable"); }catch{}
    };
    box.appendChild(c);
  });
}

/* ===== Solana (selector de tokens) =====
   Podés ampliar/editar esta lista sin tocar el resto. */
const SOLANA_TOKENS = [
  {k:"sol", label:"SOL"},
  {k:"wld", label:"WLD"},
  {k:"xrp", label:"XRP"},
  {k:"ada", label:"ADA"},
  {k:"avax",label:"AVAX"},
  {k:"doge",label:"DOGE"},
  {k:"trx", label:"TRX"},
  {k:"link",label:"LINK"},
  {k:"pol", label:"POL"},
  {k:"dot", label:"DOT"},
  {k:"shib",label:"SHIB"},
  {k:"ltc", label:"LTC"},
  {k:"bch", label:"BCH"},
  {k:"xlm", label:"XLM"},
  {k:"ftm", label:"FTM"},
  {k:"aave",label:"AAVE"},
  {k:"uni", label:"UNI"},
  {k:"algo",label:"ALGO"},
  {k:"bat", label:"BAT"},
  {k:"paxg",label:"PAXG"},
  {k:"cake",label:"CAKE"},
  {k:"axs", label:"AXS"},
  {k:"slp", label:"SLP"},
  {k:"mana",label:"MANA"},
  {k:"sand",label:"SAND"},
  {k:"chz", label:"CHZ"},
  {k:"bnb", label:"BNB"}
];
let currentSolToken = "sol";
function setupSolanaChips(){
  const box = document.getElementById("chips-solana");
  box.innerHTML = "";
  SOLANA_TOKENS.forEach(s=>{
    const c = document.createElement("div");
    c.className = "chip" + (s.k===currentSolToken ? " active": "");
    c.textContent = s.label;
    c.onclick = async ()=>{
      currentSolToken = s.k;
      document.querySelectorAll("#chips-solana .chip").forEach(x=>x.classList.remove("active"));
      c.classList.add("active");
      document.getElementById("tbl-solana").innerHTML = `<tr><td colspan="3" class="mut">Cargando ${s.label}…</td></tr>`;
      try{ renderTableFromCriptoYa(await fetchCripto(s.k,"ars"), "tbl-solana"); }catch{}
    };
    box.appendChild(c);
  });
}

/* ===== INIT ===== */
(async ()=>{
  await loadDolar();
  await Promise.all([loadBTC(), loadETH()]);

  setupStableChips();
  // carga inicial USDT
  try{ renderTableFromCriptoYa(await fetchCripto(currentStable,"ars"), "tbl-stable"); }catch{}

  setupSolanaChips();
  // carga inicial SOL
  try{ renderTableFromCriptoYa(await fetchCripto(currentSolToken,"ars"), "tbl-solana"); }catch{}
})();
</script>
</body>
</html>
