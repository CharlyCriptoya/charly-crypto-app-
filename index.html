<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Charly Cripto • App</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    :root{
      --txt:#e8ecf1; --mut:#9aa3b2; --card:rgba(15,17,25,.78);
      --line:rgba(255,255,255,.08); --chip:#232833; --chipOn:#2962ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
      /* Fondo MURO en la raíz, nombre en MAYÚSCULA */
      background:#0b0d12 url("/Muro.jpg") center/cover fixed no-repeat;
    }
    .scrim{position:fixed;inset:0;background:linear-gradient(180deg,rgba(7,9,12,.55),rgba(7,9,12,.85))}
    .wrap{position:relative;max-width:1120px;margin:0 auto;padding:16px}
    h1{margin:0 0 10px;font-size:22px}
    .card{
      backdrop-filter: blur(10px) saturate(120%); -webkit-backdrop-filter: blur(10px) saturate(120%);
      background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px;
      box-shadow:0 6px 20px rgba(0,0,0,.35);
    }
    .mut{color:var(--mut);font-size:13px}
    .grid{display:grid;gap:14px}
    @media(min-width:980px){ .grid{grid-template-columns:1fr .8fr} }

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);font-size:14px}
    th{text-align:left;font-weight:600}
    .pairs{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      padding:8px 12px;border-radius:10px;border:1px solid var(--line);
      background:var(--chip);color:#e6edff;cursor:pointer;user-select:none
    }
    .chip.active{background:var(--chipOn);border-color:transparent}
  </style>
</head>
<body>
<div class="scrim"></div>
<div class="wrap">
  <h1>Charly Cripto • App</h1>

  <div class="grid">
    <!-- Widget dólar -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Cotizaciones del dólar (ARS)</h3>
        <div class="mut" id="dolar-time">—</div>
      </div>
      <table>
        <tbody>
          <tr><td>Dólar Oficial</td><td>venta <span id="of-ask">—</span></td><td>compra <span id="of-bid">—</span></td></tr>
          <tr><td>Dólar Tarjeta</td><td>venta <span id="tar-ask">—</span></td><td>compra <span id="tar-bid">—</span></td></tr>
          <tr><td>Dólar Blue</td><td>venta <span id="blue-ask">—</span></td><td>compra <span id="blue-bid">—</span></td></tr>
          <tr><td>Dólar MEP</td><td>venta <span id="mep-ask">—</span></td><td>compra <span id="mep-bid">—</span></td></tr>
          <tr><td>Dólar CCL</td><td>venta <span id="ccl-ask">—</span></td><td>compra <span id="ccl-bid">—</span></td></tr>
          <tr><td>Dólar Cripto</td><td>venta <span id="cripto-ask">—</span></td><td>compra <span id="cripto-bid">—</span></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Selector de pares -->
    <div class="card">
      <h3 style="margin:0 0 8px">Pares (Binance)</h3>
      <div class="pairs" id="pair-chips">
        <div class="chip active" data-symbol="BTCUSDT">BTC/USDT</div>
        <div class="chip" data-symbol="ETHUSDT">ETH/USDT</div>
        <div class="chip" data-symbol="SOLUSDT">SOL/USDT</div>
        <div class="chip" data-symbol="BNBUSDT">BNB/USDT</div>
        <div class="chip" data-symbol="ADAUSDT">ADA/USDT</div>
        <div class="chip" data-symbol="XRPUSDT">XRP/USDT</div>
        <div class="chip" data-symbol="DOGEUSDT">DOGE/USDT</div>
        <div class="chip" data-symbol="USDTARS">USDT/ARS</div>
        <div class="chip" data-symbol="USDCARS">USDC/ARS</div>
      </div>
    </div>
  </div>

  <!-- Gráfico + tabla -->
  <div class="grid" style="margin-top:14px">
    <div class="card">
      <h3 style="margin:0 0 8px">Gráfico (Binance) & Stats 24h</h3>
      <div id="tvchart" style="height:420px"></div>
      <div class="mut" style="margin-top:8px">
        Último: <span id="stat-last">—</span> · Máx 24h: <span id="stat-high">—</span> · Mín 24h: <span id="stat-low">—</span> · Cambio: <span id="stat-chg">—%</span>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Cotizaciones por Exchange</h3>
        <div class="mut" id="exch-age">—</div>
      </div>
      <table id="exch-table">
        <thead><tr><th>Exchange</th><th>Par</th><th>USD</th><th>ARS</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="mut" style="margin-top:8px">
        API: <span id="exch-status">—</span> · exchanges <span id="exch-count">0</span>
      </div>
    </div>
  </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  // ===== Config =====
  const API = {
    dolar: '/api/dolar',
    stats: (s)  => `/api/stats24h?symbol=${s}`,
    quotes: (s) => `/api/quotes?pair=${s}`
  };
  let currentSymbol = 'BTCUSDT';
  let tvWidget;

  // ===== TradingView =====
  function loadChart() {
    if (tvWidget) tvWidget.remove();
    tvWidget = new TradingView.widget({
      container_id: 'tvchart',
      symbol: 'BINANCE:'+currentSymbol,
      interval: '60', theme: 'dark', autosize: true, locale: 'es',
      timezone: 'Etc/UTC', allow_symbol_change: false
    });
  }

  // ===== Dólar =====
  async function loadDolar(){
    try{
      const r = await fetch(API.dolar, {cache:'no-store'});
      const j = await r.json();
      const fmt = v => (v==null ? '—' : '$ '+new Intl.NumberFormat('es-AR',{maximumFractionDigits:2}).format(v));
      const set = (id,v)=>document.getElementById(id).textContent=fmt(v);
      set('of-ask', j.oficial?.ask); set('of-bid', j.oficial?.bid);
      set('tar-ask', j.tarjeta?.ask); set('tar-bid', j.tarjeta?.bid);
      set('blue-ask', j.blue?.ask);   set('blue-bid', j.blue?.bid);
      set('mep-ask', j.mep?.ask);     set('mep-bid', j.mep?.bid);
      set('ccl-ask', j.ccl?.ask);     set('ccl-bid', j.ccl?.bid);
      set('cripto-ask', j.cripto?.ask); set('cripto-bid', j.cripto?.bid);
      document.getElementById('dolar-time').textContent = new Date(j.ts||Date.now()).toLocaleTimeString();
    }catch(e){ console.error('dólar error',e); }
  }

  // ===== Stats 24h =====
  async function loadStats(){
    try{
      const r = await fetch(API.stats(currentSymbol), {cache:'no-store'});
      const s = await r.json();
      document.getElementById('stat-last').textContent = s.last ?? '—';
      document.getElementById('stat-high').textContent = s.high24h ?? '—';
      document.getElementById('stat-low').textContent  = s.low24h ?? '—';
      const chg = s.change24hPct; 
      document.getElementById('stat-chg').textContent = (chg>0?'+':'')+(chg??'—')+'%';
    }catch(e){ console.error('stats error',e); }
  }

  // ===== Quotes multi-exchange =====
  async function loadQuotes(){
    try{
      document.getElementById('exch-status').textContent = 'cargando...';
      const r = await fetch(API.quotes(currentSymbol), {cache:'no-store'});
      const arr = await r.json(); // [{exchange, pair, lastUSD, lastARS}]

      const tb = document.querySelector('#exch-table tbody');
      tb.innerHTML = '';
      const nfUSD = new Intl.NumberFormat('es-AR',{maximumFractionDigits:2});
      const nfARS = new Intl.NumberFormat('es-AR');

      arr.forEach(row=>{
        const usd = row.lastUSD==null ? '—' : nfUSD.format(row.lastUSD);
        const ars = row.lastARS==null ? '—' : '$ '+nfARS.format(row.lastARS);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.exchange}</td><td>${row.pair}</td><td>${usd}</td><td>${ars}</td>`;
        tb.appendChild(tr);
      });
      document.getElementById('exch-count').textContent = arr.length;
      document.getElementById('exch-status').textContent = 'ok';
      document.getElementById('exch-age').textContent = new Date().toLocaleTimeString();
    }catch(e){
      document.getElementById('exch-status').textContent = 'error';
      console.error('quotes error',e);
    }
  }

  // ===== Chips =====
  document.getElementById('pair-chips').addEventListener('click', (ev)=>{
    const chip = ev.target.closest('.chip[data-symbol]');
    if(!chip) return;
    document.querySelectorAll('.chip[data-symbol]').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    currentSymbol = chip.dataset.symbol;
    loadChart(); loadStats(); loadQuotes();
  });

  // ===== Init + refresh =====
  loadChart(); loadStats(); loadQuotes(); loadDolar();
  setInterval(loadDolar, 15000);
  setInterval(()=>{ loadStats(); loadQuotes(); }, 15000);
</script>
</body>
</html>
