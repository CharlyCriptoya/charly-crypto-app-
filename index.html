<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto ‚Ä¢ App</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --txt:#e8ecf1; --mut:#a5afc3; --card:rgba(15,17,25,.66);
    --line:rgba(255,255,255,.08); --chip:#111522; --chipOn:#0f3a7a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
    /* Fondo: Muro.jpg en la RA√çZ */
    background:#0b0d12 url("/Muro.jpg") center/cover fixed no-repeat;
  }
  .scrim{position:fixed;inset:0;background:linear-gradient(180deg,rgba(5,7,10,.58),rgba(5,7,10,.86))}
  .wrap{position:relative;max-width:1180px;margin:0 auto;padding:16px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  h1{margin:0;font-size:22px}
  .mut{color:#a5afc3}
  .ttl{font-size:12px;color:#a5afc3;text-transform:uppercase;letter-spacing:.4px}
  .big{font-size:20px;font-weight:800}

  .card{
    backdrop-filter: blur(12px) saturate(120%); -webkit-backdrop-filter: blur(12px) saturate(120%);
    background:var(--card); border:1px solid var(--line); border-radius:18px; padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.3);
  }

  /* layout */
  .stack{display:grid;gap:14px;margin-top:10px}
  .grid-2{display:grid;gap:14px}
  @media(min-width:980px){ .grid-2{grid-template-columns:1.05fr .95fr} }

  .d-grid{display:grid;gap:10px}
  @media(min-width:640px){.d-grid{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:980px){.d-grid{grid-template-columns:repeat(3,1fr)}}
  .d-box{background:rgba(17,19,27,.6); border:1px solid var(--line); border-radius:14px; padding:12px}

  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:#111522;color:#c9d6ff;border:1px solid var(--line);padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer}
  .chip.active{background:#0f3a7a;color:#fff;border-color:transparent}

  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px solid var(--line);font-size:14px}
  .table th{text-align:left;color:#a5afc3;font-weight:600}
  .table td:last-child{text-align:right}

  .topbar{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
  .cta{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:rgba(17,19,27,.6);color:#dbe9ff;text-decoration:none}

  .footer{margin:18px 0 8px;color:#a5afc3;font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="scrim"></div>
<div class="wrap">

  <!-- Header -->
  <div class="topbar">
    <h1>Charly Cripto ‚Ä¢ App</h1>
    <a class="cta" href="https://chat.openai.com" target="_blank" rel="noopener">IA de An√°lisis T√©cnico</a>
  </div>

  <!-- 1) WIDGET DEL D√ìLAR (ARRIBA) -->
  <div class="card">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div class="row"><span class="ttl">Cotizaciones del D√≥lar (ARS)</span></div>
      <div class="mut" id="usd-time">‚Äî</div>
    </div>
    <div class="d-grid">
      <div class="d-box"><div class="ttl">D√≥lar Oficial</div>
        <div class="row" style="justify-content:space-between">
          <div>venta<br><span class="big" id="of-ask">‚Äî</span></div>
          <div>compra<br><span class="big" id="of-bid">‚Äî</span></div>
        </div></div>
      <div class="d-box"><div class="ttl">D√≥lar Tarjeta</div>
        <div class="row" style="justify-content:space-between">
          <div>venta<br><span class="big" id="tar-ask">‚Äî</span></div>
          <div>compra<br><span class="big" id="tar-bid">‚Äî</span></div>
        </div></div>
      <div class="d-box"><div class="ttl">D√≥lar Blue</div>
        <div class="row" style="justify-content:space-between">
          <div>venta<br><span class="big" id="blue-ask">‚Äî</span></div>
          <div>compra<br><span class="big" id="blue-bid">‚Äî</span></div>
        </div></div>
      <div class="d-box"><div class="ttl">D√≥lar MEP</div>
        <div class="row" style="justify-content:space-between">
          <div>venta<br><span class="big" id="mep-ask">‚Äî</span></div>
          <div>compra<br><span class="big" id="mep-bid">‚Äî</span></div>
        </div></div>
      <div class="d-box"><div class="ttl">D√≥lar CCL</div>
        <div class="row" style="justify-content:space-between">
          <div>venta<br><span class="big" id="ccl-ask">‚Äî</span></div>
          <div>compra<br><span class="big" id="ccl-bid">‚Äî</span></div>
        </div></div>
      <div class="d-box"><div class="ttl">D√≥lar Cripto</div>
        <div class="row" style="justify-content:space-between">
          <div>venta<br><span class="big" id="cripto-ask">‚Äî</span></div>
          <div>compra<br><span class="big" id="cripto-bid">‚Äî</span></div>
        </div></div>
    </div>
    <div class="mut" style="margin-top:8px">act: <span id="usd-age">‚Äî</span></div>
  </div>

  <!-- 2) EXCHANGES (USD + ARS)  |  3) GR√ÅFICO + CTA -->
  <div class="grid-2">
    <!-- Tabla de EXCHANGES -->
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="ttl">Cotizaciones por Exchange</div>
        <div class="mut" id="exch-age">‚Äî</div>
      </div>
      <table class="table" id="exch-table">
        <thead>
          <tr><th>Exchange</th><th>Par</th><th>√öltimo (USD)</th><th>En ARS</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="mut" style="margin-top:8px">API: <span id="exch-status">‚Äî</span> ¬∑ exchanges <span id="exch-count">0</span>/23</div>
    </div>

    <!-- Gr√°fico -->
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="ttl">Gr√°fico (BINANCE) & Stats 24 h</div>
        <a class="cta" href="https://chat.openai.com" target="_blank" rel="noopener">An√°lisis t√©cnico</a>
      </div>

      <!-- Selector de PARES -->
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="ttl">Pares (Binance) ¬∑ <span id="pair-label">BINANCE:BTCUSDT ‚Ä¢ 1h</span></div>
      </div>
      <div class="chips" id="pair-chips">
        <div class="chip active" data-symbol="BTCUSDT">BTC/USDT</div>
        <div class="chip" data-symbol="ETHUSDT">ETH/USDT</div>
        <div class="chip" data-symbol="SOLUSDT">SOL/USDT</div>
        <div class="chip" data-symbol="BNBUSDT">BNB/USDT</div>
        <div class="chip" data-symbol="ADAUSDT">ADA/USDT</div>
        <div class="chip" data-symbol="XRPUSDT">XRP/USDT</div>
        <div class="chip" data-symbol="DOGEUSDT">DOGE/USDT</div>
        <div class="chip" data-symbol="USDTARS">USDT/ARS</div>
        <div class="chip" data-symbol="USDCARS">USDC/ARS</div>
      </div>

      <div id="tvchart" style="height:380px;margin-top:8px"></div>
      <div class="row" style="gap:16px;margin-top:8px">
        <div class="mut">√öltimo: <span id="stat-last">‚Äî</span></div>
        <div class="mut">M√°x 24h: <span id="stat-high">‚Äî</span></div>
        <div class="mut">M√≠n 24h: <span id="stat-low">‚Äî</span></div>
        <div class="mut">Cambio: <span id="stat-chg">‚Äî</span></div>
      </div>
    </div>
  </div>

  <div class="footer">Hecho con üíô por Charly ‚Äî App. Actualiza cada 15s.</div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  const API = {
    dolar: '/api/dolar',
    stats: (s) => `/api/stats24h?symbol=${s}`,
    quotes: (s) => `/api/quotes?pair=${s}`
  };

  let currentSymbol = 'BTCUSDT';
  let tvWidget;
  let usdToArs = null; // d√≥lar cripto (venta) para convertir

  /* ====== TradingView (Binance 1h) ====== */
  function loadBinanceChart(symbol='BTCUSDT', interval='60') {
    const tvSymbol = `BINANCE:${symbol}`;
    if (tvWidget) tvWidget.remove();
    tvWidget = new TradingView.widget({
      symbol: tvSymbol, interval, container_id: 'tvchart',
      autosize: true, theme: 'dark', locale: 'es',
      timezone: 'Etc/UTC', allow_symbol_change: false
    });
    document.getElementById('pair-label').textContent = `${tvSymbol} ‚Ä¢ 1h`;
  }

  /* ====== D√ìLAR (CriptoYa normalizado desde el server) ====== */
  async function fetchDolar(){
    try{
      const r = await fetch(API.dolar,{cache:'no-store'});
      const j = await r.json();

      // guardo d√≥lar cripto (venta) para convertir USD -> ARS
      usdToArs = j.cripto?.ask ?? null;

      const fmt = n => n==null ? '‚Äî' : '$ '+new Intl.NumberFormat('es-AR',{maximumFractionDigits:2}).format(n);
      const set = (id, v) => document.getElementById(id).textContent = fmt(v);

      set('of-ask', j.oficial?.ask); set('of-bid', j.oficial?.bid);
      set('tar-ask', j.tarjeta?.ask); set('tar-bid', j.tarjeta?.bid);
      set('blue-ask', j.blue?.ask);   set('blue-bid', j.blue?.bid);
      set('mep-ask', j.mep?.ask);     set('mep-bid', j.mep?.bid);
      set('ccl-ask', j.ccl?.ask);     set('ccl-bid', j.ccl?.bid);
      set('cripto-ask', j.cripto?.ask); set('cripto-bid', j.cripto?.bid);

      document.getElementById('usd-time').textContent = new Date(j.ts||Date.now()).toLocaleTimeString();
      document.getElementById('usd-age').textContent = '0s';
    }catch(e){
      document.getElementById('usd-time').textContent = 'error';
    }
  }

  /* ====== Stats 24h (Binance) ====== */
  async function fetchStats(symbol){
    try{
      const r = await fetch(API.stats(symbol), {cache:'no-store'});
      const s = await r.json();
      document.getElementById('stat-last').textContent = s.last ?? '‚Äî';
      document.getElementById('stat-high').textContent = s.high24h ?? '‚Äî';
      document.getElementById('stat-low').textContent  = s.low24h ?? '‚Äî';
      const chg = s.change24hPct;
      document.getElementById('stat-chg').textContent = (chg>0?'+':'') + (chg??'‚Äî') + '%';
    }catch(e){}
  }

  /* ====== EXCHANGES (USD + ARS) ====== */
  async function fetchQuotes(symbol){
    try{
      const r = await fetch(API.quotes(symbol), {cache:'no-store'});
      const arr = await r.json();

      const fmtUSD = v => v==null ? '‚Äî' : '$ ' + new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(v);
      const fmtARS = v => v==null ? '‚Äî' : '$ ' + new Intl.NumberFormat('es-AR',{maximumFractionDigits:0}).format(v);

      const tb = document.querySelector('#exch-table tbody');
      tb.innerHTML = '';
      (arr||[]).forEach(row=>{
        // Soporta server nuevo (last_usd/last_ars) y server viejo (last) + conversi√≥n local
        const last_usd = row.last_usd ?? row.last ?? null;
        const last_ars = row.last_ars ?? (usdToArs && last_usd ? +(last_usd*usdToArs).toFixed(0) : null);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.exchange}</td>
          <td>${row.pair || symbol}</td>
          <td>${fmtUSD(last_usd)}</td>
          <td>${fmtARS(last_ars)}</td>
        `;
        tb.appendChild(tr);
      });

      document.getElementById('exch-age').textContent = new Date().toLocaleTimeString();
      document.getElementById('exch-count').textContent = (arr||[]).length;
      document.getElementById('exch-status').textContent = 'ok';
    }catch(e){
      document.getElementById('exch-status').textContent = 'error';
    }
  }

  /* ====== Chips ====== */
  document.getElementById('pair-chips').addEventListener('click', (ev)=>{
    const chip = ev.target.closest('.chip[data-symbol]');
    if(!chip) return;
    document.querySelectorAll('.chip[data-symbol]').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    currentSymbol = chip.dataset.symbol;
    loadBinanceChart(currentSymbol,'60');
    fetchStats(currentSymbol);
    fetchQuotes(currentSymbol);
  });

  /* ====== Init + refresh ====== */
  loadBinanceChart();
  fetchDolar(); fetchStats(currentSymbol); fetchQuotes(currentSymbol);
  setInterval(()=>{ fetchDolar(); fetchStats(currentSymbol); fetchQuotes(currentSymbol); }, 15000);
</script>
</body>
</html>
