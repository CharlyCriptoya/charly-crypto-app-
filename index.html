<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto • MVP</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg:#0d0f12; --txt:#e9edf3; --mut:#9aa3b2;
    --card:#141824; --line:#232838; --chip:#1b2030; --ok:#59d499; --warn:#ffd166;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; color:var(--txt);
    background: var(--bg) url("./Muro.jpeg") center/cover fixed no-repeat;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  }
  @media (prefers-color-scheme: dark){
    body{ background-image: linear-gradient(180deg,#0d0f12 0%, #101424 100%) }
  }
  .wrap{ max-width:1100px; margin:0 auto; padding:12px }
  header{ display:flex; align-items:center; gap:10px; margin:8px 0 10px }
  h1{ margin:0; font-size:18px; letter-spacing:.2px }
  .pill{ font-size:12px; background:var(--chip); padding:6px 10px; border-radius:999px; color:var(--mut) }

  .widget{ background:rgba(20,24,36,.84); backdrop-filter: blur(6px); border:1px solid rgba(35,40,56,.6); border-radius:14px; padding:12px }
  .grid-2{ display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0,1fr)); }
  @media (min-width:700px){ .grid-2{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
  @media (min-width:980px){ .grid-2{ grid-template-columns: repeat(6, minmax(0,1fr)); } }

  .tile{ background:linear-gradient(180deg,#171b2a, #121522); border:1px solid var(--line); border-radius:12px; padding:12px }
  .k{ font-size:11px; color:var(--mut); letter-spacing:.4px }
  .row{ display:flex; justify-content:space-between; align-items:center; margin-top:8px }
  .lab{ font-size:12px; color:var(--mut) }
  .val{ font:600 18px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif }
  .sub{ font-size:11px; color:var(--mut); margin-top:6px }
  .hint{ color:var(--mut); font-size:12px; margin-top:6px }

  .section{ margin:14px 0 }
  .card{ background:rgba(20,24,36,.84); border:1px solid var(--line); border-radius:14px; padding:14px }
  .section h2{ margin:0 0 8px; font-size:20px }
  .pair{ margin:10px 0 6px; font:600 14px/1 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; color:#dfe6f3 }
  .exlist{ font-size:13px; color:#dfe6f3 }
  .exrow{ display:flex; justify-content:space-between; padding:6px 8px; border:1px solid #21263a; border-radius:10px; background:#141826; margin-top:6px }
  .mut{ color:var(--mut) }

  footer{ color:var(--mut); font-size:12px; margin:16px 0 30px; text-align:center }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Charly Cripto • MVP</h1><span class="pill">Alpha</span>
    </header>

    <!-- WIDGET DÓLAR (2 columnas en celular) -->
    <div class="widget">
      <div class="grid-2" id="dolarGrid"></div>
      <div class="hint" id="dolarHint">Actualizando…</div>
    </div>

    <!-- EXCHANGES -->
    <div class="section">
      <div class="card">
        <h2>Exchanges &amp; Pares</h2>
        <div class="mut">USD y ARS (ARS calculado con dólar cripto &mdash;venta&mdash;)</div>

        <div class="pair">BTC/USDT</div>
        <div id="btcRows"></div>

        <div class="pair" style="margin-top:12px">ETH/USDT</div>
        <div id="ethRows"></div>

        <div class="pair" style="margin-top:12px">USDT (stable)</div>
        <div id="usdtRows"></div>

        <div class="pair" style="margin-top:12px">USDC (stable)</div>
        <div id="usdcRows"></div>

        <div class="pair" style="margin-top:12px">DAI (stable)</div>
        <div id="daiRows"></div>

        <div class="hint" id="exHint"></div>
      </div>
    </div>

    <!-- GRÁFICO (placeholder, tu widget existente) -->
    <div class="section">
      <div class="card">
        <h2>Gráfico BTC/USDT</h2>
        <div class="mut">Acá va tu widget TradingView / Binance (el que ya te funciona).</div>
      </div>
    </div>

    <footer>Hecho con ❤️ por Charly • Buenos Aires</footer>
  </div>

<script>
/* ------------ Utilidades ------------- */
const $ = s => document.querySelector(s);
function fmtARS(n){ return Number(n).toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:2}); }
function fmtUSD(n){ return Number(n).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}); }
async function fetchJSON(url){
  try{
    const r = await fetch(url, {cache:'no-store'});
    if(r.ok) return await r.json();
    // Fallback a allorigins si CORS/HTTP falla
    const rr = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
    if(!rr.ok) throw new Error('fallback http');
    const payload = await rr.json();
    return JSON.parse(payload.contents);
  }catch(e){
    throw e;
  }
}

/* ------------ DÓLARES 6 WIDGETS ------------- */
const DOLAR_ORDER = [
  { key:'oficial', label:'DÓLAR OFICIAL' },
  { key:'tarjeta', label:'DÓLAR TARJETA' },
  { key:'blue',    label:'DÓLAR BLUE' },
  { key:'mep',     label:'DÓLAR MEP' },
  { key:'ccl',     label:'DÓLAR CCL' },
  { key:'cripto',  label:'DÓLAR CRIPTO' },
];

function renderDolarGrid(data){
  const grid = $('#dolarGrid');
  grid.innerHTML = '';
  DOLAR_ORDER.forEach(({key,label})=>{
    const o = data?.[key] || {};
    const venta = Number(o.venta ?? o.value ?? o.promedio ?? NaN);
    const compra = Number(o.compra ?? NaN);
    const tile = document.createElement('div'); tile.className = 'tile';
    tile.innerHTML = `
      <div class="k">${label}</div>
      <div class="row"><div class="lab">venta</div><div class="val">${isFinite(venta)? fmtARS(venta) : '—'}</div></div>
      <div class="row"><div class="lab">compra</div><div class="val">${isFinite(compra)? fmtARS(compra) : '—'}</div></div>
      <div class="sub">act: 0s</div>
    `;
    grid.appendChild(tile);
  });
}

async function loadDolares(){
  try{
    $('#dolarHint').textContent = 'Actualizando…';
    // Si tenés server: usa /api/dolar ; si no, directo a CriptoYa
    const data = await fetchJSON('/api/dolar').catch(()=>fetchJSON('https://criptoya.com/api/dolar'));
    renderDolarGrid(data);
    const ts = new Date();
    $('#dolarHint').innerHTML = `Última actualización: ${ts.toLocaleTimeString('es-AR')} <span style="color:var(--ok)">OK</span>`;
    // Devolvemos el dólar cripto venta para ARS conversion
    const criptoVenta = Number(data?.cripto?.venta ?? data?.usdt ?? data?.cripto);
    return isFinite(criptoVenta)? criptoVenta : null;
  }catch(e){
    console.error(e);
    $('#dolarHint').innerHTML = `No se pudo actualizar <span style="color:var(--warn)">${String(e)}</span>`;
    return null;
  }
}

/* ------------ EXCHANGES & PARES ------------- */
/* Implementado sólido: BINANCE (CORS OK). Marcados /hookeados para agregar BYBIT/OKX/MEXC/KUCOIN/RIPIO/LEMON/LETSBIT/etc. */
const EXCHANGES = [
  {
    name:'Binance',
    id:'binance',
    pairs:{
      'BTCUSDT': async()=> (await fetchJSON('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT')).price,
      'ETHUSDT': async()=> (await fetchJSON('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT')).price,
      'USDTUSD': async()=> 1.00,
      'USDCUSD': async()=> 1.00,
      'DAIUSD':  async()=> 1.00,
    }
  },
  // Estructura para próximos (quedan conectados si hay CORS o usando server proxy)
  { name:'Bybit', id:'bybit', pairs:{
      'BTCUSDT': async()=> { throw new Error('CORS/bybit'); },
      'ETHUSDT': async()=> { throw new Error('CORS/bybit'); },
      'USDTUSD': async()=> 1.00, 'USDCUSD': async()=> 1.00, 'DAIUSD': async()=> 1.00,
  }},
  { name:'OKX', id:'okx', pairs:{
      'BTCUSDT': async()=> { throw new Error('CORS/okx'); },
      'ETHUSDT': async()=> { throw new Error('CORS/okx'); },
      'USDTUSD': async()=> 1.00, 'USDCUSD': async()=> 1.00, 'DAIUSD': async()=> 1.00,
  }},
  { name:'MEXC', id:'mexc', pairs:{
      'BTCUSDT': async()=> { throw new Error('CORS/mexc'); },
      'ETHUSDT': async()=> { throw new Error('CORS/mexc'); },
      'USDTUSD': async()=> 1.00, 'USDCUSD': async()=> 1.00, 'DAIUSD': async()=> 1.00,
  }},
  { name:'KuCoin', id:'kucoin', pairs:{
      'BTCUSDT': async()=> { throw new Error('CORS/kucoin'); },
      'ETHUSDT': async()=> { throw new Error('CORS/kucoin'); },
      'USDTUSD': async()=> 1.00, 'USDCUSD': async()=> 1.00, 'DAIUSD': async()=> 1.00,
  }},
  // Locales AR: placeholder (suelen requerir auth o CORS cerrado)
  { name:'Ripio', id:'ripio', pairs:{ 'BTCUSDT':async()=>{throw new Error('API/permiso');}, 'ETHUSDT':async()=>{throw new Error('API/permiso');}, 'USDTUSD':async()=>1.00, 'USDCUSD':async()=>1.00, 'DAIUSD':async()=>1.00 }},
  { name:'Lemon', id:'lemon', pairs:{ 'BTCUSDT':async()=>{throw new Error('API/permiso');}, 'ETHUSDT':async()=>{throw new Error('API/permiso');}, 'USDTUSD':async()=>1.00, 'USDCUSD':async()=>1.00, 'DAIUSD':async()=>1.00 }},
  { name:'Let’sBit', id:'letsbit', pairs:{ 'BTCUSDT':async()=>{throw new Error('API/permiso');}, 'ETHUSDT':async()=>{throw new Error('API/permiso');}, 'USDTUSD':async()=>1.00, 'USDCUSD':async()=>1.00, 'DAIUSD':async()=>1.00 }},
  { name:'Buenbit', id:'buenbit', pairs:{ 'BTCUSDT':async()=>{throw new Error('API/permiso');}, 'ETHUSDT':async()=>{throw new Error('API/permiso');}, 'USDTUSD':async()=>1.00, 'USDCUSD':async()=>1.00, 'DAIUSD':async()=>1.00 }},
  { name:'Belo', id:'belo', pairs:{ 'BTCUSDT':async()=>{throw new Error('API/permiso');}, 'ETHUSDT':async()=>{throw new Error('API/permiso');}, 'USDTUSD':async()=>1.00, 'USDCUSD':async()=>1.00, 'DAIUSD':async()=>1.00 }},
];

function renderRow(container, ex, pair, usd, ars){
  const row = document.createElement('div');
  row.className = 'exrow';
  row.innerHTML = `<div>${ex}</div><div>${fmtUSD(usd)} <span class="mut">· ${fmtARS(ars)}</span></div>`;
  container.appendChild(row);
}

async function loadPairs(usdArsRate){
  const $btc = $('#btcRows'), $eth = $('#ethRows'), $usdt=$('#usdtRows'), $usdc=$('#usdcRows'), $dai=$('#daiRows');
  [$btc,$eth,$usdt,$usdc,$dai].forEach(el=>el.innerHTML='');

  let okCount = 0;
  for(const ex of EXCHANGES){
    // BTC
    try{
      const p = await ex.pairs['BTCUSDT']();
      const usd = Number(p);
      const ars = usd * usdArsRate;
      renderRow($btc, ex.name, 'BTC/USDT', usd, ars); okCount++;
    }catch(_){}
    // ETH
    try{
      const p = await ex.pairs['ETHUSDT']();
      const usd = Number(p);
      const ars = usd * usdArsRate;
      renderRow($eth, ex.name, 'ETH/USDT', usd, ars); okCount++;
    }catch(_){}
    // Stablecoins (solo interesa ARS)
    for(const [pair, el] of [['USDTUSD',$usdt],['USDCUSD',$usdc],['DAIUSD',$dai]]){
      try{
        const p = await ex.pairs[pair](); // ~1.00
        const usd = Number(p);
        const ars = usd * usdArsRate;
        renderRow(el, ex.name, pair.replace('USD','/USD'), usd, ars); okCount++;
      }catch(_){}
    }
  }
  $('#exHint').textContent = okCount? `Actualizado · ${okCount} cotizaciones mostradas` : 'No se pudieron obtener cotizaciones (probar con server proxy)';
}

/* ------------ Bootstrap ------------- */
let lastSecs = 0;
async function tick(){
  const rate = await loadDolares();               // dólar cripto (venta)
  if(rate) await loadPairs(rate);
}
tick();
setInterval(()=>{
  // actualiza contador "act: Xs"
  lastSecs += 1;
  document.querySelectorAll('.tile .sub').forEach(x=> x.textContent = `act: ${lastSecs}s`);
  if(lastSecs % 30 === 0){ lastSecs = 0; tick(); }
},1000);
</script>
</body>
</html>
