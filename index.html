<script>
const $ = s => document.querySelector(s);
function toNum(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }
function fmtARS(n){ return Number(n).toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:2}); }

// ——— Aliases por si la API cambia los nombres ———
const KEY_ALIASES = {
  oficial: ['oficial'],
  tarjeta: ['tarjeta','solidario','qatar'],
  blue:    ['blue'],
  mep:     ['mep'],
  ccl:     ['ccl'],
  cripto:  ['cripto','usdt'] // a veces viene como "usdt"
};

// Normaliza cualquier shape (número u objeto con venta/compra/value/promedio/sell/buy)
function normalizeQuote(x){
  if (x == null) return {venta:null, compra:null};
  if (typeof x === 'number') return {venta:x, compra:x};
  if (typeof x === 'string' && !isNaN(Number(x))) { const n=Number(x); return {venta:n, compra:n}; }
  const venta = toNum(x.venta ?? x.sell ?? x.ask ?? x.value ?? x.promedio);
  const compra = toNum(x.compra ?? x.buy ?? x.bid ?? x.value ?? x.promedio);
  if (venta!=null && compra==null) return {venta, compra:venta};
  if (compra!=null && venta==null) return {venta:compra, compra};
  return {venta:venta??null, compra:compra??null};
}

async function fetchJSON(url){
  try{
    const r = await fetch(url, {cache:'no-store'});
    if(r.ok) return await r.json();
    throw new Error('http '+r.status);
  }catch(_){
    // fallback directo a CriptoYa si /api/dolar no responde
    const rr = await fetch('https://criptoya.com/api/dolar', {cache:'no-store'});
    if(!rr.ok) throw new Error('criptoya '+rr.status);
    return await rr.json();
  }
}

const ORDER = [
  { id:'oficial', label:'DÓLAR OFICIAL' },
  { id:'tarjeta', label:'DÓLAR TARJETA' },
  { id:'blue',    label:'DÓLAR BLUE' },
  { id:'mep',     label:'DÓLAR MEP' },
  { id:'ccl',     label:'DÓLAR CCL' },
  { id:'cripto',  label:'DÓLAR CRIPTO' },
];

function pickByAliases(data, id){
  const names = KEY_ALIASES[id] || [id];
  for (const k of names){
    if (data && data[k] != null) return data[k];
  }
  return null;
}

function renderGrid(data){
  const grid = document.getElementById('dolarGrid');
  grid.innerHTML = '';
  ORDER.forEach(({id,label})=>{
    const raw = pickByAliases(data, id);
    const q = normalizeQuote(raw);

    const div = document.createElement('div');
    div.className = 'tile';
    div.innerHTML = `
      <div class="k">${label}</div>
      <div class="row"><div class="lab">venta</div><div class="val">${q.venta!=null? fmtARS(q.venta) : '—'}</div></div>
      <div class="row"><div class="lab">compra</div><div class="val">${q.compra!=null? fmtARS(q.compra) : '—'}</div></div>
      <div class="sub">act: 0s</div>
    `;
    grid.appendChild(div);
  });
}

let seconds = 0;
async function loadDolares(){
  try{
    document.getElementById('dolarHint').textContent = 'Actualizando…';
    const data = await fetchJSON('/api/dolar');  // usa tu server.js
    renderGrid(data);
    document.getElementById('dolarHint').innerHTML =
      `Última actualización: ${new Date().toLocaleTimeString('es-AR')} <span style="color:#59d499">OK</span>`;
    seconds = 0;
    console.log('Dólar keys:', Object.keys(data||{})); // debug
  }catch(e){
    console.error(e);
    document.getElementById('dolarHint').innerHTML =
      `No se pudo actualizar <span style="color:#ffd166">${String(e.message||e)}</span>`;
  }
}

// Primera carga + cada 30s. Contador “act: Xs”.
loadDolares();
setInterval(loadDolares, 30_000);
setInterval(()=> {
  seconds += 1;
  document.querySelectorAll('.tile .sub').forEach(x=> x.textContent = `act: ${seconds}s`);
}, 1000);
</script>
