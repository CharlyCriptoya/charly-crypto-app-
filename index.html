<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto • MVP</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --bg:#0d0f12; --txt:#e9edf3; --mut:#9aa3b2; --card:#141824; --line:#232838;
    --good:#27d39f; --bad:#ff6b6b; --chip:#1b2030;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--txt);
    background:#0d0f12 url("./Muro.jpeg") center/cover fixed no-repeat;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  }
  .veil{background: linear-gradient(180deg, rgba(13,15,18,.60), rgba(13,15,18,.85)); min-height:100vh;}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0 0 10px;font-size:22px;letter-spacing:.2px}
  .mut{color:var(--mut)}
  .card{background: rgba(20,24,36,.86); border:1px solid var(--line); border-radius:12px; padding:12px; box-shadow: 0 6px 24px rgba(0,0,0,.28);}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);font-size:14px}
  th{text-align:left; font-size:13px; color:var(--mut); text-transform:uppercase; letter-spacing:.4px}
  tr:hover td{background:rgba(255,255,255,.02)}
  .usdbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .chip{background:var(--chip); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-weight:600; font-size:13px}
  .chartwrap{height:480px}
  .ai-actions{display:flex;gap:8px;flex-wrap:wrap}
  .ai-btn{background:#1d2a44;border:1px solid var(--line);color:var(--txt);padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:13px}
</style>
</head>
<body>
<div class="veil">
  <div class="wrap">

    <h1>Charly Cripto • MVP <span class="mut">/ cotizaciones y señales rápidas</span></h1>

    <!-- WIDGET DÓLAR -->
    <div class="card">
      <div class="usdbar" id="usdbar">
        <span class="mut">Cotizaciones del dólar (AR):</span>
      </div>
    </div>

    <!-- PAR 1: BTC/USDT -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>BTC / USDT</strong> <span class="mut">• spot</span></div>
      </div>
      <div style="margin-top:8px;overflow:auto">
        <table>
          <thead>
            <tr><th>Exchange</th><th>Par</th><th>Precio (USD)</th><th>Estimado (ARS)</th></tr>
          </thead>
          <tbody id="body-btc"></tbody>
        </table>
      </div>
    </div>

    <!-- PAR 2: ETH/USDT -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>ETH / USDT</strong> <span class="mut">• spot</span></div>
      </div>
      <div style="margin-top:8px;overflow:auto">
        <table>
          <thead>
            <tr><th>Exchange</th><th>Par</th><th>Precio (USD)</th><th>Estimado (ARS)</th></tr>
          </thead>
          <tbody id="body-eth"></tbody>
        </table>
      </div>
    </div>

    <!-- PAR 3: USDT/ARS (estimado con blue) -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>USDT / ARS</strong> <span class="mut">• estimado con blue</span></div>
      </div>
      <div style="margin-top:8px;overflow:auto">
        <table>
          <thead>
            <tr><th>Exchange</th><th>Par</th><th>Precio (USD)</th><th>Estimado (ARS)</th></tr>
          </thead>
          <tbody id="body-usdtars"></tbody>
        </table>
      </div>
      <div class="mut" style="margin-top:6px; font-size:12px">* ARS estimado usando dólar blue como referencia rápida.</div>
    </div>

    <!-- GRÁFICO -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div><strong>Gráfico</strong> <span class="mut">/ BTCUSDT</span></div>
        <div class="mut" style="font-size:12px">Widget: TradingView</div>
      </div>
      <div class="chartwrap" id="chart"></div>
    </div>

    <!-- “IA” / ANÁLISIS TÉCNICO -->
    <div class="card" style="margin-top:12px">
      <div><strong>Análisis técnico rápido</strong> <span class="mut">/ EMA, RSI, MACD</span></div>
      <div class="ai-actions">
        <button class="ai-btn" id="analyzeBtn">Analizar BTCUSDT (15m)</button>
        <span id="lastPrice" class="chip">—</span>
      </div>
      <pre id="aiOut" class="mono" style="white-space:pre-wrap; margin:0"></pre>
    </div>

    <div class="mut" style="margin:14px 2px 0; font-size:12px">Healthcheck: <code class="mono">/healthz</code>.</div>

  </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  const fmt = (n, d=2)=> Number(n).toLocaleString('es-AR',{maximumFractionDigits:d});
  const EX = [
    {name:"Binance", key:"binance", map:(p)=>p},
    {name:"Bybit",   key:"bybit",   map:(p)=>p}, // ahora spot
    {name:"OKX",     key:"okx",     map:(p)=>p.replace("USDT","-USDT")},
    {name:"KuCoin",  key:"kucoin",  map:(p)=>p.replace("USDT","-USDT")},
    {name:"MEXC",    key:"mexc",    map:(p)=>p},
    {name:"Bitget",  key:"bitget",  map:(p)=>p}, // spot
  ];
  let dolarBlue = null;

  async function loadDolar(){
    try{
      const r = await fetch("/api/dolar");
      if(!r.ok) throw 0;
      const j = await r.json();
      const bar = document.getElementById("usdbar");
      bar.innerHTML = '<span class="mut">Cotizaciones del dólar (AR):</span>';
      const add = (label,v)=>{
        if(v==null || !isFinite(Number(v))) return;
        const s = document.createElement("span");
        s.className = "chip"; s.textContent = `${label}: $ ${fmt(v)}`;
        bar.appendChild(s);
      };
      add("Oficial", j.oficial);
      add("Tarjeta", j.tarjeta);
      add("Blue", j.blue);
      add("MEP", j.mep);
      add("CCL", j.ccl);
      dolarBlue = isFinite(Number(j.blue)) ? Number(j.blue) : null;
    }catch(e){
      console.log("dolar widget off");
    }
  }

  async function fetchTicker(ex, symbol){
    const r = await fetch(`/api/ticker?exchange=${ex}&symbol=${symbol}`);
    if(!r.ok) throw 0;
    return r.json();
  }

  async function fillPair(tbodyId, pair){
    const tb = document.getElementById(tbodyId);
    tb.innerHTML = "<tr><td colspan='4' class='mut'>Cargando…</td></tr>";

    let rows = await Promise.all(EX.map(async ex=>{
      try{
        const mapped = ex.map(pair);
        const j = await fetchTicker(ex.key, mapped);
        const usd = Number(j.price);
        const ars = dolarBlue ? usd * dolarBlue : null;
        return {exchange: ex.name, par: pair.replace("USDT","/USDT"), usd, ars};
      }catch{
        return {exchange: ex.name, par: pair.replace("USDT","/USDT"), usd: null, ars: null};
      }
    }));

    tb.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.exchange}</td>
        <td>${r.par}</td>
        <td>${r.usd!=null ? `$ ${fmt(r.usd,2)}` : "—"}</td>
        <td>${r.ars!=null ? `$ ${fmt(r.ars,0)}` : "—"}</td>`;
      tb.appendChild(tr);
    });
  }

  // Chart
  let tvWidget=null;
  function setTVSymbol(sym){
    if (!window.TradingView) return;
    if (tvWidget) { try { tvWidget.remove(); } catch {} }
    tvWidget = new TradingView.widget({
      symbol: sym, interval: "15", container_id: "chart",
      autosize: true, timezone: "America/Argentina/Buenos_Aires",
      theme: "dark", style: "1", locale: "es"
    });
  }

  // “IA” local
  async function analyze(){
    const out = document.getElementById("aiOut"); out.textContent = "Calculando…";
    try{
      const r = await fetch("/api/klines?symbol=BTCUSDT&interval=15m&limit=500");
      const kl = await r.json();
      const closes = kl.map(k=>Number(k[4]));
      const last = closes.at(-1);
      document.getElementById("lastPrice").textContent = `BTCUSDT: $ ${fmt(last,2)}`;

      const ema=(a,p)=>{const k=2/(p+1);let e=a[0];for(let i=1;i<a.length;i++)e=a[i]*k+e*(1-k);return e};
      const sma=(a,p)=>a.slice(-p).reduce((x,y)=>x+y,0)/p;
      const rsi=(a,p=14)=>{let g=0,l=0;for(let i=a.length-p;i<a.length;i++){const d=a[i]-a[i-1];if(d>=0)g+=d;else l+=-d}const rs=(g/p)/((l/p)||1e-9);return 100-(100/(1+rs))};
      const macd=(()=>{const e=(s,n)=>{const k=2/(n+1);let e=sma(s.slice(0,n),n);for(let i=n;i<s.length;i++)e=s[i]*k+e*(1-k);return e};const m=e(closes,12)-e(closes,26);const sig=m*0.8;return {m, sig, h:m-sig}})();

      const ema20=ema(closes.slice(-120),20), ema50=ema(closes.slice(-200),50), rsi14=rsi(closes,14);
      let bias="Neutral"; if(ema20>ema50 && rsi14<70 && macd.h>0) bias="Alcista"; if(ema20<ema50 && rsi14>30 && macd.h<0) bias="Bajista";
      const risk=0.0075, reward=0.015, side=bias==="Alcista"?"LARGO":bias==="Bajista"?"CORTO":"ESPERAR";
      const sl=bias==="Alcista"?last*(1-risk):bias==="Bajista"?last*(1+risk):null, tp=bias==="Alcista"?last*(1+reward):bias==="Bajista"?last*(1-reward):null;

      out.textContent =
`Señal (15m): ${bias}
Precio: ${fmt(last,2)} USD

EMA20: ${fmt(ema20,2)} | EMA50: ${fmt(ema50,2)}
RSI14: ${fmt(rsi14,1)} | MACD: ${fmt(macd.m,2)} / Señal: ${fmt(macd.sig,2)} / Hist: ${fmt(macd.h,2)}

Sugerencia: ${side}
${sl ? `Stop Loss: ${fmt(sl,2)} USD` : ""} ${tp ? `| Take Profit: ${fmt(tp,2)} USD` : ""}

*Educativo. No es asesoramiento financiero.*`;
    }catch{ out.textContent = "No pude calcular indicadores."; }
  }

  // Init
  (async ()=>{
    await loadDolar();
    setTVSymbol("BINANCE:BTCUSDT");
    await fillPair("body-btc", "BTCUSDT");
    await fillPair("body-eth", "ETHUSDT");
    // USDT/ARS: usamos USD=1 → ARS=blue
    const tb = document.getElementById("body-usdtars");
    tb.innerHTML = "";
    EX.forEach(ex=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ex.name}</td>
        <td>USDT/ARS</td>
        <td>$ 1,00</td>
        <td>${dolarBlue? `$ ${fmt(dolarBlue,0)}` : "—"}</td>`;
      tb.appendChild(tr);
    });
    document.getElementById("analyzeBtn").onclick = analyze;
  })();
</script>
</body>
</html>
