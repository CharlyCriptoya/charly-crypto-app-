<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto • MVP</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{--bg:#0d0f12;--txt:#e9edf3;--mut:#9aa3b2;--card:#141824;--line:#232838;--ok:#59d499;--warn:#ffd166}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  header{display:flex;align-items:center;gap:10px;margin:8px 0 12px}
  h1{margin:0;font-size:18px}
  .pill{font-size:12px;background:#1b2030;color:var(--mut);padding:6px 10px;border-radius:999px}

  .widget{background:#141824cc;border:1px solid var(--line);border-radius:14px;padding:12px}
  .grid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (min-width:700px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media (min-width:980px){.grid{grid-template-columns:repeat(6,minmax(0,1fr))}}
  .tile{background:linear-gradient(180deg,#171b2a,#121522);border:1px solid var(--line);border-radius:12px;padding:12px}
  .k{font-size:11px;color:var(--mut);letter-spacing:.4px}
  .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .lab{font-size:12px;color:var(--mut)}
  .val{font:600 18px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
  .sub{font-size:11px;color:var(--mut);margin-top:6px}
  .hint{color:var(--mut);font-size:12px;margin-top:6px}

  /* Barra de errores visible en pantalla */
  #errbar{position:fixed;left:8px;right:8px;bottom:8px;background:#351b1b;border:1px solid #5b2a2a;color:#ffd7d7;
          border-radius:10px;padding:8px 10px;font-size:12px;display:none;z-index:9999;white-space:pre-wrap}
</style>
</head>
<body>
  <div class="wrap">
    <header><h1>Charly Cripto • MVP</h1><span class="pill">Alpha</span></header>

    <div class="widget">
      <div class="grid" id="dolarGrid"></div>
      <div class="hint" id="dolarHint">Actualizando…</div>
    </div>
  </div>

  <div id="errbar"></div>

<script>
(function(){
  // ======= Captura errores para que NUNCA quede en blanco =======
  const errbar = document.getElementById('errbar');
  function showErr(msg){
    errbar.textContent = '⚠️ ' + msg;
    errbar.style.display = 'block';
  }
  window.addEventListener('error', e => showErr(e.message || String(e)));
  window.addEventListener('unhandledrejection', e => showErr(e.reason && e.reason.message ? e.reason.message : String(e.reason||e)));

  // ======= Util =======
  const $ = s => document.querySelector(s);
  const toNum = x => { const n = Number(x); return Number.isFinite(n) ? n : null; };
  const fmtARS = n => Number(n).toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:2});

  const KEY_ALIASES = {
    oficial:['oficial'],
    tarjeta:['tarjeta','solidario','qatar'],
    blue:['blue'],
    mep:['mep'],
    ccl:['ccl'],
    cripto:['cripto','usdt']
  };
  const ORDER = [
    { id:'oficial', label:'DÓLAR OFICIAL' },
    { id:'tarjeta', label:'DÓLAR TARJETA' },
    { id:'blue',   label:'DÓLAR BLUE' },
    { id:'mep',    label:'DÓLAR MEP' },
    { id:'ccl',    label:'DÓLAR CCL' },
    { id:'cripto', label:'DÓLAR CRIPTO' },
  ];

  function normalizeQuote(x){
    if (x==null) return {venta:null, compra:null};
    if (typeof x==='number') return {venta:x, compra:x};
    if (typeof x==='string' && !isNaN(Number(x))) { const n=Number(x); return {venta:n, compra:n}; }
    const venta = toNum(x.venta ?? x.sell ?? x.ask ?? x.value ?? x.promedio);
    const compra= toNum(x.compra ?? x.buy  ?? x.bid ?? x.value ?? x.promedio);
    return {venta: venta ?? compra ?? null, compra: compra ?? venta ?? null};
  }
  function pickByAliases(data, id){
    const names = KEY_ALIASES[id] || [id];
    for (const k of names) if (data && data[k] != null) return data[k];
    return null;
  }

  async function fetchJSON(){
    // Primero intenta tu proxy /api/dolar (server.js). Si no, directo a CriptoYa.
    try{
      const r = await fetch('/api/dolar', {cache:'no-store'});
      if(r.ok) return await r.json();
      throw new Error('HTTP /api/dolar '+r.status);
    }catch(_){
      const rr = await fetch('https://criptoya.com/api/dolar', {cache:'no-store'});
      if(!rr.ok) throw new Error('HTTP CriptoYa '+rr.status);
      return await rr.json();
    }
  }

  function renderGrid(data){
    const grid = $('#dolarGrid'); grid.innerHTML = '';
    ORDER.forEach(({id,label})=>{
      const raw = pickByAliases(data, id);
      const q = normalizeQuote(raw);
      const div = document.createElement('div'); div.className = 'tile';
      div.innerHTML = `
        <div class="k">${label}</div>
        <div class="row"><div class="lab">venta</div><div class="val">${q.venta!=null? fmtARS(q.venta) : '—'}</div></div>
        <div class="row"><div class="lab">compra</div><div class="val">${q.compra!=null? fmtARS(q.compra) : '—'}</div></div>
        <div class="sub">act: 0s</div>
      `;
      grid.appendChild(div);
    });
  }

  let secs = 0;
  async function loadDolares(){
    try{
      $('#dolarHint').textContent = 'Actualizando…';
      const data = await fetchJSON();
      renderGrid(data);
      $('#dolarHint').innerHTML = `Última actualización: ${new Date().toLocaleTimeString('es-AR')} <span style="color:var(--ok)">OK</span>`;
      secs = 0;
    }catch(e){
      showErr(e.message || String(e));
      $('#dolarHint').innerHTML = `No se pudo actualizar <span style="color:var(--warn)}">${e.message||e}</span>`;
    }
  }

  // Boot
  loadDolares();
  setInterval(loadDolares, 30000);
  setInterval(()=>{ secs++; document.querySelectorAll('.tile .sub').forEach(x=> x.textContent = `act: ${secs}s`); }, 1000);
})();
</script>
</body>
</html>
